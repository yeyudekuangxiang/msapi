<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Search</title>
    <style>
        /* 简单的响应式样式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 600px;
            margin: auto;
        }
        input[type="text"] {
            width: calc(100% - 100px);
            padding: 10px;
            margin-right: 10px;
        }
        button {
            padding: 10px;
        }
        .song-list {
            margin-top: 20px;
        }
        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }
    </style>
</head>
<body>
<div id="app" class="container">
    <div>
        <input type="text" v-model="query" placeholder="Search for songs...">
        <button @click="searchSongs">Search</button>
    </div>
    <div>
        <select v-model="site">
            <option value="163">网易云音乐</option>
            <option value="freemp3">freemp3</option>
        </select>
    </div>
    <div class="song-list">
        <div v-for="song in songs" :key="song.ID" class="song-item">
            <div>
                <strong>{{ song.Name }}</strong> -
                <span v-for="ar in song.Artist">{{ ar.Name }}</span>
                <span>{{ song.Album?song.Album.Name:"无" }}</span>
            </div>
            <div>
                <button @click="playSong(song)">Play</button>
                <button @click="syncSong(song)">Sync</button>
            </div>
        </div>
    </div>
    <div class="music-player">
        <audio ref="audio" @timeupdate="updateTime">
            <source v-for="source in currentTrack.sources" :src="source.src" :type="source.type">
            Your browser does not support the audio element.
        </audio>

        <div class="player-controls">
            <button @click="togglePlay">{{ isPlaying ? 'Pause' : 'Play' }}</button>
            <span>{{ currentTrack.name }} - {{ currentTrack.artist }}</span>
            <span>{{ formatTime(currentTime) }} / {{ formatTime(duration) }}</span>
        </div>
    </div>
</div>

<!-- 引入Vue和Axios -->
<script src="./vue.js"></script>
<script src="./axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            site:'163',
            query: '',
            songs: [],
            currentTrackIndex: 0,
            isPlaying: false,
            currentTime: 0,
            duration: 0,
            currentTrack:{}
        },
        methods: {
            togglePlay() {
                const audio = this.$refs.audio;
                //audio.load()
                if (this.isPlaying) {
                    audio.pause();
                } else {
                    audio.play();
                }
                this.isPlaying = !this.isPlaying;
            },
            updateTime(event) {
                this.currentTime = event.target.currentTime;
                this.duration = event.target.duration;
            },
            formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${minutes}:${secs}`;
            },
            searchSongs() {
                const apiUrl = `/api/music/search?keyword=${this.query}&page=1&size=100&site=${this.site}`; // 替换为实际的API URL
                axios.get(apiUrl)
                    .then(response => {
                        console.log(response)
                        this.songs = response.data.data.list; // 假设API返回的数据格式
                    })
                    .catch(error => {
                        console.error('Error fetching songs:', error);
                    });
            },
            playSong(song) {
                console.log(song)
                if(!song.Quality || song.Quality.length===0){
                    alert("没有播放质量")
                    return
                }
                let quality = song.Quality.slice(-1)[0]

                const apiUrl = `/api/music/play?id=${song.ID}&site=${this.site}&quality=${quality}`; // 替换为实际的API URL
                axios.get(apiUrl)
                    .then(response => {
                        console.log(response)
                        this.currentTrack = {
                            name:song.Name,
                            artist:"",
                            sources:response.data.data.song.sources,
                        }
                        const audio = this.$refs.audio;
                        audio.load()
                        console.log('Playing song:', song.name);
                        this.isPlaying = false
                        this.togglePlay()
                    })
                    .catch(error => {
                        console.error('Error fetching songs:', error);
                    });

                // 实现播放逻辑
            },
            syncSong(song) {
                console.log(song)
                if(!song.Quality || song.Quality.length===0){
                    alert("没有播放质量")
                    return
                }
                let quality = song.Quality.slice(-1)[0]

                let artistName = ""
                for (let i = 0;i<song.Artist.length;i++){
                    artistName+=","+song.Artist[i].Name
                }
                if (artistName.length>0){
                    artistName = artistName.substring(1)
                }
                const apiUrl = `/api/music/sync?id=${song.ID}&site=${this.site}&quality=${quality}&singerName=${artistName}&musicName=${song.Name}`; // 替换为实际的API URL
                axios.get(apiUrl)
                    .then(response => {
                        console.log(response)
                        if (response.data.code==200){
                            alert("同步成功")
                        }else{
                            alert("同步失败"+response.data.msg)
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching songs:', error);
                    });
                // 实现播放逻辑
            },
        }
    });
</script>
</body>
</html>